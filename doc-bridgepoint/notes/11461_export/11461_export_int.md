---

This work is licensed under the Creative Commons CC0 License

---

# Enhanced MASL Export Mechanism
### xtUML Project Implementation Note

### 1. Abstract

Currently, MASL is exported using the “Export MASL Project” and “Export MASL
Domain” context menu utilities. This is functional, but usability could be
increased by packaging the exporter as a project builder.

### 2. Document References

<a id="2.1"></a>2.1 [BridgePoint DEI #11461](https://support.onefact.net/issues/11461) Main issue.  
<a id="2.2"></a>2.2 [BridgePoint DEI #8334](https://support.onefact.net/issues/8334) Issue which originally introduced the x2m plugin.  
<a id="2.3"></a>2.3 [Project SRS (internal document)](https://docs.google.com/document/d/14eUh9kFz_i3o7cYbi_L1BQ7EAxrAq38806vm3PkcnJ8/edit)  
<a id="2.4"></a>2.4 [BridgePoint SR #10320](https://support.onefact.net/issues/10320) Project Primus Documentation  
<a id="2.5"></a>2.5 [BridgePoint DEI #11491](https://support.onefact.net/issues/11491) Refresh model compilers  
<a id="2.6"></a>2.6 [BridgePoint DEI #10525](https://support.onefact.net/issues/10525) Implement deployments  
<a id="2.7"></a>2.7 [BridgePoint DEI #11493](https://support.onefact.net/issues/11493) Manual test issue  

### 3. Background

When the MASL export utility was introduced, it was copied from the docgen
plugin and modified to invoke the `xtuml2masl` utility instead of the `docgen`
executable. New CMEs were added for components and packages to access this
functionality.

Later, when MASL export was needed to validate names in MASL action language
with the Xtext MASL editor, a "refresher" utility was added to the MASL exporter
to do a quick export (no action language, no pretty formatting) every time a
MASL editor is opened. This provides the Xtext editor with up to date structural
MASL with which to validate against.

This approach is functional, however it is not intuitive when working in a
typical editing/building/testing/editing flow. Every time a model is edited,
MASL must be regenerated by using the CME before the project is built and the
MASL compiler/C++ builder runs. It was determined that this could be streamlined
such that the MASL exporter is a step in the build chain instead of a separate
operation from a CME. This fits more with the pattern of other Eclipse based
tools.

### 4. Requirements

Requirements have been copied from [[2.3]](#2.3) and are shown here for
convenience.

4.1 The “Export MASL Project” and “Export MASL Domain” menu options shall be
removed  
4.2 The MASL exporter shall be selectable during xtUML model creation in the
list of available model compilers  
4.3 Model elements to export shall be configurable during project creation or at
a later time via project properties  
4.4 If no model element to export is configured, reasonable default behavior
shall be employed  
4.5 The MASL exporter shall run for applicable projects when “Build Project” or
“Build All” is executed  
4.6 The output from the MASL exporter shall remain consistent  
4.7 The user shall have the ability to export MASL domains independently of MASL
deployments  

### 5. Work Required

5.1 Add `org.xtuml.bp.mc.masl` project

A new plugin project was added which encapsulates the MASL exporter model
compiler. The `plugin.xml` file was set up to extend the model compilers
extension point and add the MASL exporter to the list of available model
compilers.

5.1.1 Extend `AbstractExportBuilder`

A new `IncrementalProjectBuilder` was implemented to extend
`AbstractExportBuilder`. This builder handles the MASL export. Most of the code
here was copied and adapted from the original x2m plugin. This class knows how
to determine which elements in a project may be exported to MASL and determine a
reasonable default set of elements to build.

5.1.1.1 MASL exportable elements

All components and deployments found within a project are presented to the user
as possible build elements (see section 5.1.2).

5.1.1.2 MASL default element to export

If the default element to export is used, it is chosen the following way:

Each top level project package is searched.
If a deployment is found, the deployment is
exported. If no deployment is found, a search for component references is made.
If component references are found in the package, the package itself is exported
using the old MASL project idiom. If no component references are found, a search
for components is made. If components are found, each component is exported as a
domain.

This same algorithm is used to determine what element should be exported by the
MASL refresher.

5.1.2 Add properties page

A project properties page was added to configure the MASL export for a project.
If the defaults are left untouched, the behavior is identical to current
behavior. The preferences allow users to choose which elements to export,
enable/disable the formatter, suppress action language export, and choose the
output location.

![properties.png](properties.png)

These properties are stored in a file called `org.xtuml.bp.mc.masl.prefs` in the
`.settings/` directory under a project. It has been implemented such that this
file is only created if the user chooses options other than the defaults. It is
expected that these properties will be left with defaults most of the time, so
it was desirable to not create that file unless necessary.

5.1.3 Update build order/link into maven build

Work was done to integrate this new plugin into the maven build and assure that
it is built and packaged in the correct order.

5.2 Revamp x2m plugin

Since the x2m plugin is no longer being used for export, it was repurposed to be
a generic Java implementation of the xtuml2masl flow. When this was first
introduced, the plumbing of `x2m` and `masl` together was done in the
`xtumlmc_build` Perl script. There were some race conditions that were popping
up during implementation and it is generally desirable to use this script
_less_. Because of these factors, it was decided to remove this plumbing from
the script and implement it as an Eclipse plugin. It was carefully designed with
no dependencies such that it could be invoked from the `org.xtuml.bp.mc.masl`
builder plugin but also from the command line.

5.3 Update `xtumlmc_build` and `xtuml2masl` scripts

The xtuml2masl flow implementation was removed from the `xtumlmc_build` Perl
script. The `xtuml2masl` bash script was updated to invoke the Java application
packaged in the x2m plugin.

5.4 Remove MASL Export CMES

The old "Export MASL Domain" and "Export MASL Project" CMEs have been removed.

### 6. Implementation Comments

6.1 This pull request includes several code clean up items such as replacing
tabs with spaces, removing copyright headers and such.

6.2 Fixed a mistake in the schema that was missed during the work on #10525
[[2.6]](#2.6)

6.3 This work lays the groundwork for issue #11491 [[2.5]](#2.5). Some of that
work was going to be done in this work, but it was decided to defer it because
it is too high risk so close to a release.

6.4 Since `xtumlmc_build` was changed, technically, the Windows version would
need to be repackaged.  However, since the change only removes functionality,
there is no need to perform this repackage at this time.

6.5 The MASL exporter is selectable from the "Set Model Compiler" wizard as
well as at project creation.

### 7. Unit Test

7.1 Existing passing unit tests shall pass

7.2 Manual test procedure

See [[2.7]](#2.7)

### 8. User Documentation

8.1 Documentation for this work will be incorporated into the documentation
provided as part of issue #10320 [[2.4]](#2.4).

8.2 Palette and context menu documentation shall be updated along with MASL
documentation.

### 9. Code Changes

Fork/Repository: leviathan747/bridgepoint  
Branch: 11461_export  

<pre>

 doc-bridgepoint/notes/11461_export/11461_export_int.md                                                                             | 231 +++++++++++++++++++++++++++++++++++++++++
 doc-bridgepoint/notes/11461_export/properties.png                                                                                  | Bin 0 -> 248545 bytes
 doc-bridgepoint/review-minutes/11461_export_int_rvm.md                                                                             |  29 ++++++
 releng/org.xtuml.bp.releng.parent/pom.xml                                                                                          |   3 +-
 src/MC-Java/ooa_schema.sql                                                                                                         |   4 +-
 src/org.xtuml.bp.cdt/src/org/xtuml/bp/cdt/wizards/BridgePointCDTProjectWizard.java                                                 |   6 ++
 src/org.xtuml.bp.mc.c.source/src/org/xtuml/bp/mc/c/source/Activator.java                                                           | 110 ++++++++++----------
 src/org.xtuml.bp.mc.masl/.classpath                                                                                                |   7 ++
 src/org.xtuml.bp.mc.masl/.externalToolBuilders/Build.launch                                                                        |  15 +++
 src/org.xtuml.bp.mc.masl/.externalToolBuilders/Clean.launch                                                                        |  10 ++
 src/org.xtuml.bp.mc.masl/.gitignore                                                                                                |   1 +
 src/org.xtuml.bp.mc.masl/.project                                                                                                  |  48 +++++++++
 src/org.xtuml.bp.mc.masl/.settings/org.eclipse.jdt.core.prefs                                                                      |   7 ++
 src/org.xtuml.bp.mc.masl/META-INF/MANIFEST.MF                                                                                      |  24 +++++
 src/org.xtuml.bp.mc.masl/build.properties                                                                                          |  10 ++
 src/org.xtuml.bp.mc.masl/build_settings/build_setting.properties                                                                   |   9 ++
 src/org.xtuml.bp.mc.masl/plugin.xml                                                                                                |  46 +++++++++
 src/org.xtuml.bp.mc.masl/pom.xml                                                                                                   |  15 +++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/Activator.java                                                                   |  94 +++++++++++++++++
 src/{org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/refresher => org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl}/MASLEditorPartListener.java |  26 +++--
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/MCNature.java                                                                    |  81 +++++++++++++++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/MCNewProjectWizard.java                                                          |  49 +++++++++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/MaslExportBuilder.java                                                           | 269 ++++++++++++++++++++++++++++++++++++++++++++++++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/SingleEntryStringMap.java                                                        |  97 +++++++++++++++++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/preferences/MaslExporterPreferencePage.java                                      | 211 +++++++++++++++++++++++++++++++++++++
 src/org.xtuml.bp.mc.masl/src/org/xtuml/bp/mc/masl/preferences/MaslExporterPreferences.java                                         | 151 +++++++++++++++++++++++++++
 src/org.xtuml.bp.mc/META-INF/MANIFEST.MF                                                                                           |   1 +
 src/org.xtuml.bp.mc/build.properties                                                                                               |   2 +-
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/AbstractActivator.java                                                                     | 192 +++++++++++++++-------------------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/AbstractExportBuilder.java                                                                 | 472 +++++++++++++++++++++++++++++++++++++++++------------------------------------------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/AbstractNature.java                                                                        | 913 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/AbstractNewProjectWizard.java                                                              | 114 ++++++++++----------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/AbstractProperties.java                                                                    |  84 ++++++++-------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/MCBuilderArgumentHandler.java                                                              | 260 ++++++++++++++++++++++------------------------
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/tools/SwitchProjectModelCompilerAction.java                                                |  17 ---
 src/org.xtuml.bp.mc/src/org/xtuml/bp/mc/tools/SwitchProjectModelCompilerWizard.java                                                |  47 ++++-----
 src/org.xtuml.bp.pkg-feature/feature.xml                                                                                           |   6 ++
 src/org.xtuml.bp.x2m/META-INF/MANIFEST.MF                                                                                          |  22 +---
 src/org.xtuml.bp.x2m/build.properties                                                                                              |   3 +-
 src/org.xtuml.bp.x2m/plugin.xml                                                                                                    |  77 --------------
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/X2MPlugin.java                                                                           | 105 -------------------
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/Xtuml2Masl.java                                                                          | 401 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/actions/ExportDomainAction.java                                                          |  40 --------
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/actions/ExportProjectAction.java                                                         |  40 --------
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/generator/Generator.java                                                                 | 424 ---------------------------------------------------------------------------
 src/org.xtuml.bp.x2m/src/org/xtuml/bp/x2m/refresher/Refresher.java                                                                 | 333 -----------------------------------------------------------
 46 files changed, 2902 insertions(+), 2204 deletions(-)

</pre>

Fork/Repository: leviathan747/mc  
Branch: 11461_export  

<pre>

 bin/xtuml2masl    |   4 +---
 bin/xtumlmc_build | 177 ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 2 files changed, 1 insertion(+), 180 deletions(-)

</pre>

### End

